/*! OpenCrisp PathJS - v0.1.0 - 2015-07-30
* http://opencrisp.wca.at
* Copyright (c) 2015 Fabian Schmid; Licensed MIT */
!function(a){function b(a){return v(a,"Function")}function c(a,b){for(var c=0;a>c;c+=1)b="false"===b||b===!1?!0:!b;return b}function d(b,c){var d;if(b)return b._reason={},a.defineEvent(b._reason),b._reason.eventListener({limit:1,action:"success",listen:function(a){d=a.data}}),b.exec(c),d}function e(a){var b,c,d,f,h=new g(this,a);for(f=d=h.add(1),this.level+=1,D.lastIndex=this.index;!c&&(b=D.exec(this.path));)this.index=D.lastIndex,E+=1,void 0!==b[1]?(f._operator=b[1],f=f.value=h.add()):void 0!==b[2]?f._reverse=b[2].length:void 0!==b[3]?(d._next=b[3],f=d=h.add(1)):void 0!==b[4]?f.child=e.call(this,f):void 0!==b[5]?c=!0:void 0!==b[6]?f.child=new q(f,Number(b[6])):void 0!==b[7]?f.child=new q(f,"true"===b[7]):void 0!==b[8]?f.child=new q(f,b[8].replace(y,'"')):void 0!==b[9]?f.child=new q(f,b[9].replace(z,"'")):void 0!==b[10]?f.child=new q(f,new RegExp(b[10],b[11])):void 0!==b[12]?f.child=new q(f,this.valueKey(b[12])):(this.index=b.index,f.parse()),D.lastIndex=this.index;return this.level-=1,h}function f(a){var b;if(a.next("&")){if(b=d(a,this.node),!b)throw new w}else if(a.next("|")){if(b=d(a,this.node))throw this.reason.eventTrigger({action:"success",args:b}),new w}else a.exec(this.node)}function g(a,b){b||(this._reason=a),Object.defineProperty(this,"_parent",{value:b}),this.condition=[]}function h(a){Object.defineProperty(this,"_parent",{value:a})}function i(a){var b;G.lastIndex=this.index;var c=G.exec(this.path);if(c){if(this.index=G.lastIndex,void 0!==c[1])b=new l(a).parse();else if(void 0!==c[2]||void 0!==c[4])b=new k(a,c[2]||c[4],c[3]).parse();else if(void 0!==c[5])b=new m(a,c[5]).parse();else if(void 0!==c[6])b=new n(a,c[6]).parse();else if(void 0!==c[7])b=new m(a,this.valueKey(c[7])).parse();else if(void 0!==c[8])b=o.call(this,a);else{if(void 0===c[9])return void(this.index=c.index);b=new j(a).parse()}return b}}function j(a){Object.defineProperty(this,"_parent",{value:a})}function k(a,b,c){Object.defineProperty(this,"_parent",{value:a}),this._start=Number(b),this._limit=c&&Math.abs(c)}function l(a){Object.defineProperty(this,"_parent",{value:a})}function m(a,b){Object.defineProperty(this,"_parent",{value:a}),this._attr=b}function n(a,b){Object.defineProperty(this,"_parent",{value:a}),this._type=b}function o(a){var b,c;if(a instanceof p||(c=new p(a)),J.lastIndex=this.index,b=J.exec(this.path),!b)return c;if(this.index=J.lastIndex,void 0!==b[1])c=new p(a);else{if(void 0===b[2])return this.index=b.index,c;c=new p(a,b[2]),b[3]&&b[3].length>0&&(c._args=JSON.parse("["+b[3]+"]"))}return c.parse()}function p(a,b){Object.defineProperty(this,"_parent",{value:a}),this._name=b}function q(a,b){Object.defineProperty(this,"_parent",{value:a}),this._value=b}function r(a){if(this.child)return this.child.exec(a);var b=this.reason(),c=b.eventPicker({cache:b,action:"complete"});if(b.eventTrigger({action:"success",args:a}),c.Note({data:a}),c.Talk(),-1!==b.limit&&c.note.Length()>=b.limit)throw c.Talk(),new x}function s(a){var b=e.call(a);try{b.exec(this)}catch(c){if(c instanceof x)return;if(void 0!==a.preset)return void a.eventTrigger({action:"success",args:a.preset});if(c instanceof w)return;throw new Error(c)}}function t(a){this.index=a.index,this.path=a.path,this.values=a.values,this.preset=a.preset,this.limit=a.limit,this.async=a.async,this.level=a.level,this.filter=a.filter}var u=a.utilTick,v=a.isType,w=a.ns("util.control.Break"),x=a.ns("util.control.End"),y=/\\"/g,z=/\\'/g,A={">":function(a,b){return a>b},"<":function(a,b){return b>a},">=":function(a,b){return a>=b},"<=":function(a,b){return b>=a},"==":function(a,b){return a===b},"!=":function(a,b){return a!==b}},B={"*":function(a){a.xEach({self:this,success:function(a){r.call(this,a)}})},"+":function(a){this.child&&(this._specific=this.child.filter),d(this.specific(),a)&&this.child.exec(a)},"#":function(a){var b=this.specific(),c=b?d(b,a):!0;c&&(this.child.exec(a),v(a.xEach,"Function")&&a.xEach({self:this,success:function(a){B["#"].call(this,a)}}))}},C='\\s*(?:(\\!=|[<>=]{1,2})|(\\!+)|(&|\\|)|(\\[|\\()|(\\]|\\))\\.?|([0-9]+(?:\\.[0-9]+)?)(?!\\.|:)|(true|false)|"((?:[^"\\\\]*|\\\\"|\\\\)*)"|'+"'((?:[^'\\\\]*|\\\\'|\\\\)*)'|\\/((?:[^\\/\\\\]*|\\\\\\/|\\\\)+)\\/([igm]{1,3})?|\\$([\\w]+)|.+)\\s*",D=new RegExp(C,"g"),E=0;g.prototype={parent:function(a){return a?this._parent&&b(this._parent[a])&&this._parent[a]():this._parent},reason:function(){return this._reason||this.parent("reason")},specific:function(){return this._specific||this.parent("specific")},add:function(a){var b=new h(this);return a&&this.condition.push(b),b},exec:function(a){var b=this.reason(),c=b.eventPicker({cache:b,action:"complete"});this.condition.xEach({self:{node:a,reason:b},success:f}),c.Talk()}},h.prototype={parent:function(a){return a?this._parent&&b(this._parent[a])&&this._parent[a]():this._parent},reason:function(){return this._reason||this.parent("reason")},specific:function(){return this._specific||this.parent("specific")},parse:function(){return this.child=i.call(this.reason(),this),this},exec:function(a){var b,e;return this.reverse()||this.operator()?(b=d(this.child,a),b=c(this.reverse(),b),this.operator()&&(e=d(this.value,a),e instanceof RegExp&&(b=e.test(b),e=!0),b=A[this.operator()](b,e)),void this.reason().eventTrigger({action:"success",args:b})):r.call(this,a)},reverse:function(){return this._reverse||0},operator:function(){return this._operator||0},next:function(a){return a?this._next===a:this._next}};var F="\\s*(?:(\\.)|(?:(-?[0-9]+)~([0-9]+)|(-[0-9]+))\\.?|([0-9]+|[a-z][a-z0-9\\-]*)\\.?|([*#+])\\.?|\\$([a-z0-9_]+)\\.?|(:)|(\\[|\\()|.+)\\s*",G=new RegExp(F,"g");j.prototype={parent:function(a){return a?this._parent&&b(this._parent[a])&&this._parent[a]():this._parent},reason:function(){return this._reason||this.parent("reason")},specific:function(){return this._specific||this.parent("specific")},parse:function(){return this.filter=e.call(this.reason(),this),this.child=i.call(this.reason(),this),this},exec:function(a){return d(this.filter,a)?(r.call(this,a),!0):void 0}},k.prototype={parent:function(a){return a?this._parent&&b(this._parent[a])&&this._parent[a]():this._parent},reason:function(){return this._reason||this.parent("reason")},specific:function(){return this._specific||this.parent("specific")},parse:function(){return this.child=i.call(this.reason(),this),this},exec:function(a){a.xEach({self:this,start:this._start,limit:this._limit,success:function(a){r.call(this,a)}})}},l.prototype={parent:function(a){return a?this._parent&&b(this._parent[a])&&this._parent[a]():this._parent},reason:function(){return this._reason||this.parent("reason")},specific:function(){return this._specific||this.parent("specific")},parse:function(){return this.child=i.call(this.reason(),this),this},exec:function(a){r.call(this,a.__parent__)}},m.prototype={parent:function(a){return a?this._parent&&b(this._parent[a])&&this._parent[a]():this._parent},reason:function(){return this._reason||this.parent("reason")},specific:function(){return this._specific||this.parent("specific")},parse:function(){return this.child=i.call(this.reason(),this),this},exec:function(a){a[this.attr()]&&(a=a[this.attr()],r.call(this,a))},attr:function(){return this._attr}},n.prototype={parent:function(a){return a?this._parent&&b(this._parent[a])&&this._parent[a]():this._parent},reason:function(){return this._reason||this.parent("reason")},specific:function(){return this._specific||this.parent("specific")},parse:function(){return this.child=i.call(this.reason(),this),this},exec:function(a){B[this.type()].call(this,a)},type:function(){return this._type}};var H="(?:[^)\\\\]*|\\\\\\)|\\\\)+",I="(?:(\\.)|(\\w+)(?:\\(("+H+")\\))?\\.?)\\s*|.+",J=new RegExp(I,"g");p.prototype={parent:function(a){return a?this._parent&&b(this._parent[a])&&this._parent[a]():this._parent},reason:function(){return this._reason||this.parent("reason")},specific:function(){return this._specific||this.parent("specific")},parse:function(){return this.child=o.call(this.reason(),this),this},exec:function(a){if(!b(a[this.name()]))throw new Error("PathFunction "+this.name()+" is not defined!");a=a[this.name()].apply(a,this.args()),r.call(this,a)},name:function(){return this._name||"toString"},args:function(){return this._args}},q.prototype={parent:function(a){return a?this._parent&&b(this._parent[a])&&this._parent[a]():this._parent},reason:function(){return this._reason||this.parent("reason")},specific:function(){return this._specific||this.parent("specific")},exec:function(){r.call(this,this._value)}},t.prototype={valueKey:function(a){return this.values[a]}},a.definePath=function(c){Object.defineProperties(c,{pathNode:{value:function(a){var b,c=this;return a=a||"","[object String]"==={}.toString.call(a)&&(a={path:a}),a.limit=1,a.async=!1,a.success=function(a){b=a},c.pathFind(a),void 0===b&&(b=a.preset),b}},pathFind:{value:function(c){var d=this;c=c||{},c.limit=c.limit||-1,c.index=c.index||0,c.level=0;var e=new t(c);return a.defineEvent(e),b(c.success)&&e.eventListener({action:"success",self:d,listen:c.success}),b(c.complete)&&e.eventListener({action:"complete",self:d,listen:c.complete}),u(d,s,e,c.async),d}},pathExists:{value:function(a){return void 0!==this.pathNode({path:a})}}})}}(Crisp);