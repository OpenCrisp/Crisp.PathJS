/*! OpenCrisp PathJS - v0.5.0 - 2015-10-31
* http://opencrisp.wca.at/docs/util.path.html
* Copyright (c) 2015 Fabian Schmid; Licensed MIT */
!function(a){function b(a){return A.call(a,"Function")}function c(a,b){for(var c=0;a>c;c+=1)b=A.call(b,"Undefined")||"false"===b||b===!1||A.call(b,"Boolean")&&!b.valueOf()||A.call(b.isBoolean,"Function")&&b.isBoolean()&&!b.valueOf()?!0:!b;return b}function d(b,c){var d;if(b)return b._reason={},a.defineEvent(b._reason),b._reason.eventListener({limit:1,action:"success",listen:function(a){d=a}}),b.exec(c),d}function e(a){var b,c,d,f,g=new h(this,a);for(f=d=g.add(1),H.lastIndex=this._index;!c&&(b=H.exec(this._path));)this._index=H.lastIndex,I+=1,void 0!==b[1]?(f._operator=b[1],f=f.value=g.add()):void 0!==b[2]?f._reverse=b[2].length:void 0!==b[3]?(d._next=b[3],f=d=g.add(1)):void 0!==b[4]?f.child=e.call(this,f):void 0!==b[5]?c=!0:void 0!==b[6]?f.child=new s(f,Number(b[6])):void 0!==b[7]?f.child=new s(f,"true"===b[7]):void 0!==b[8]?f.child=new s(f,b[8].replace(C,'"')):void 0!==b[9]?f.child=new s(f,b[9].replace(D,"'")):void 0!==b[10]?f.child=new s(f,new RegExp(b[10],b[11])):void 0!==b[12]?f.child=new s(f,this.valueKey(b[12])):(this._index=b.index,f.parse()),H.lastIndex=this._index;return g}function f(a){var b;if(a.next("&")){if(b=d(a,this.node),!b)throw new B}else if(a.next("|")){if(b=d(a,this.node))throw this.reason.eventTrigger({action:"success",args:b}),new B}else a.exec(this.node)}function g(){}function h(a,b){b||(this._reason=a),this._parent=b,this.condition=[]}function i(a){this._parent=a}function j(a){var b;M.lastIndex=this._index;var c=M.exec(this._path);if(c){if(this._index=M.lastIndex,void 0!==c[1])b=new n(a).parse();else if(void 0!==c[3])b=new m(a,c[3]).parse(),b._revlist=c[2];else if(void 0!==c[4])b=new o(a,c[4]).parse();else if(void 0!==c[6])b=new p(a,c[6]).parse(),b._revlist=c[5];else if(void 0!==c[7])b=new o(a,this.valueKey(c[7])).parse();else if(void 0!==c[8])b=q.call(this,a);else{if(void 0===c[9])return void(this._index=c.index);b=new k(a).parse()}return b}}function k(a){this._parent=a}function l(a,b,c){try{return this._("config")[a](b)}catch(d){return b||c}}function m(a,b){this._parent=a,O.test(b)?(b=O.exec(b),this._start=b[1],this._limit=b[2]):this._start=b}function n(a){this._parent=a}function o(a,b){Object.defineProperty(this,"_parent",{value:a}),this._attr=b}function p(a,b){this._parent=a,this._type=b}function q(a){var b,c;if(a instanceof r||(c=new r(a)),V.lastIndex=this._index,b=V.exec(this._path),!b)return c;if(this._index=V.lastIndex,void 0!==b[1])c=new r(a);else{if(void 0===b[2])return this._index=b.index,c;c=new r(a,b[2]),b[3]&&b[3].length>0&&(c._args=JSON.parse("["+b[3].replace(W,"$1")+"]"))}return c.parse()}function r(a,b){this._parent=a,this._name=b}function s(a,b){this._parent=a,this._value=b}function t(a){if(this.child)return this.child.exec(a);var b=this.reason();if(!((b._count+=1)<=b._start)){var c=b.eventPicker({cache:b,action:"complete",empty:!0});if(b.eventTrigger({action:"success",args:a}),c.Note({data:a}),c.Talk(),-1!==b._limit&&c._note.Length()>=b._limit)throw c.Talk(),new B}}function u(a){var b=e.call(a);try{b.exec(this)}catch(c){if(c instanceof B)return;if(void 0!==a._preset)return void a.eventTrigger({action:"success",args:a._preset});throw c}}function v(a){this._path=a.path,this._values=a.values,this._preset=a.preset,this._limit=a.limit,this._start=a.start,this._async=a.async,this._count=0,this._index=0}function w(a){var b;return a=a||"",a.xType("String")&&(a={path:a}),a.limit=1,a.async=!1,a.success=function(a){b=a},this.pathFind(a),A.call(b,"Undefined")&&(b=A.call(a.preset,"Function")?a.preset.call(this):a.preset),b}function x(c){var d;c=c||{},d=c.self||this,c.limit=c.limit||-1,c.start=c.start||0,c.values=c.values||{},c.values.self=c.values.self||this;var e=new v(c);return a.defineEvent(e),b(c.success)&&e.eventListener({action:"success",self:d,listen:c.success}),b(c.complete)&&e.eventListener({action:"complete",self:d,listen:c.complete}),z(this,u,e,c.async),this}function y(a){return void 0!==this.pathNode({path:a})}var z=a.utilTick,A=a.type,B=function(){},C=/\\"/g,D=/\\'/g,E={">":function(a,b){return a>b},"<":function(a,b){return b>a},">=":function(a,b){return a>=b},"<=":function(a,b){return b>=a},"==":function(a,b){return a===b},"!=":function(a,b){return a!==b}},F={"*":function(a){a.xEach({self:this,reverse:this._revlist,success:function(a){t.call(this,a)}})},"+":function(a){this.child&&(this._specific=this.child.filter),d(this.specific(),a)&&this.child.exec(a)},"#":function(a){var b=this.specific(),c=b?d(b,a):!0;c&&(this.child.exec(a),(A.call(a,"Array")||A.call(a,"Object"))&&a.xEach({self:this,reverse:this._revlist,success:function(a){F["#"].call(this,a)}}))}},G='\\s*(?:(\\!=|[<>=]{1,2})|(\\!+)|(&|\\|)|(\\[|\\()|(\\]|\\))\\.?|(-?\\d+(?:\\.\\d+)?)(?![\\.:~\\d])|(true|false)|"((?:[^"\\\\]*|\\\\"|\\\\)*)"|'+"'((?:[^'\\\\]*|\\\\'|\\\\)*)'|\\/((?:[^\\/\\\\]*|\\\\\\/|\\\\)+)\\/([igm]{1,3})?|\\$([\\w]+)\\s?(?![\\w\\.:])|.+)\\s*",H=new RegExp(G,"g"),I=0;g.prototype={parent:function(a){return a?this._parent&&b(this._parent[a])&&this._parent[a]():this._parent},reason:function(){return this._reason||this.parent("reason")},specific:function(){return this._specific||this.parent("specific")}};var J=h.prototype=new g;J.add=function(a){var b=new i(this);return a&&this.condition.push(b),b},J.exec=function(a){var b=this.reason(),c=b.eventPicker({cache:b,action:"complete",empty:!0});this.condition.xEach({self:{node:a,reason:b},success:f}),c.Talk()};var K=i.prototype=new g;K.parse=function(){return this.child=j.call(this.reason(),this),this},K.exec=function(a){var b,e;return this.reverse()||this.operator()?(b=d(this.child,a),b=c(this.reverse(),b),this.operator()&&(e=d(this.value,a),e instanceof RegExp&&(b=e.test(b),e=!0),b=E[this.operator()](b,e)),void this.reason().eventTrigger({action:"success",args:b})):t.call(this,a)},K.reverse=function(){return this._reverse||0},K.operator=function(){return this._operator||0},K.next=function(a){return a?this._next===a:this._next};var L="\\s*(?:(\\.)|(\\^)?(-?\\d*~\\d*|-\\d+)\\.?|(\\d+|[a-z][a-z\\d\\-]*)\\.?|(\\^)?([*#+])\\.?|\\$([a-z\\d_]+)\\.?|(:)|(\\[|\\()|.+)\\s*",M=new RegExp(L,"g"),N=k.prototype=new g;N.parse=function(){return this.filter=e.call(this.reason(),this),this.child=j.call(this.reason(),this),this},N.exec=function(a){return d(this.filter,a)?(t.call(this,a),!0):void 0};var O=/^(-?\d+)?~(\d+)?$/,P=m.prototype=new g;P.parse=function(){return this.child=j.call(this.reason(),this),this},P.exec=function(a){a.xEach({self:this,reverse:this._revlist,start:l.call(a,"optStart",this._start,0),limit:l.call(a,"optLimit",this._limit,10),success:function(a){var b=this.specific(),c=b?d(b,a):!0;if(!c)throw new B;t.call(this,a)}})};var Q=n.prototype=new g;Q.parse=function(){return this.child=j.call(this.reason(),this),this},Q.exec=function(a){t.call(this,a.__parent__)};var R=o.prototype=new g;R.parse=function(){return this.child=j.call(this.reason(),this),this},R.exec=function(a){a[this.attr()]&&(a=a[this.attr()],t.call(this,a))},R.attr=function(){return this._attr};var S=p.prototype=new g;S.parse=function(){return this.child=j.call(this.reason(),this),this},S.exec=function(a){F[this.type()].call(this,a)},S.type=function(){return this._type};var T="(?:[^)\\\\]*|\\\\\\)|\\\\)+",U="(?:(\\.)|(\\w+)(?:\\(("+T+")\\))?\\.?)\\s*|.+",V=new RegExp(U,"g"),W=/\\([\(\)])/g,X=r.prototype=new g;X.parse=function(){return this.child=q.call(this.reason(),this),this},X.exec=function(a){b(a[this.name()])&&(a=a[this.name()].apply(a,this.args()),t.call(this,a))},X.name=function(){return this._name||"toString"},X.args=function(){return this._args};var Y=s.prototype=new g;Y.exec=function(){t.call(this,this._value)},v.prototype={valueKey:function(a){return this._values[a]}},a.ns("util.path").prototypes={pathNode:w,pathFind:x,pathExists:y},a.definePath=function(a){Object.defineProperties(a,{pathNode:{value:w},pathFind:{value:x},pathExists:{value:y}})}}(Crisp);