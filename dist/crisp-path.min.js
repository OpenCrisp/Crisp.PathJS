/*! OpenCrisp PathJS - v0.4.1 - 2015-10-02
* http://opencrisp.wca.at/docs/util.path.html
* Copyright (c) 2015 Fabian Schmid; Licensed MIT */
!function(a){function b(a){return A.call(a,"Function")}function c(a,b){for(var c=0;a>c;c+=1)b="false"===b||b===!1?!0:!b;return b}function d(b,c){var d;if(b)return b._reason={},a.defineEvent(b._reason),b._reason.eventListener({limit:1,action:"success",listen:function(a){d=a}}),b.exec(c),d}function e(a){var b,c,d,f,g=new h(this,a);for(f=d=g.add(1),I.lastIndex=this._index;!c&&(b=I.exec(this._path));)this._index=I.lastIndex,J+=1,void 0!==b[1]?(f._operator=b[1],f=f.value=g.add()):void 0!==b[2]?f._reverse=b[2].length:void 0!==b[3]?(d._next=b[3],f=d=g.add(1)):void 0!==b[4]?f.child=e.call(this,f):void 0!==b[5]?c=!0:void 0!==b[6]?f.child=new s(f,Number(b[6])):void 0!==b[7]?f.child=new s(f,"true"===b[7]):void 0!==b[8]?f.child=new s(f,b[8].replace(D,'"')):void 0!==b[9]?f.child=new s(f,b[9].replace(E,"'")):void 0!==b[10]?f.child=new s(f,new RegExp(b[10],b[11])):void 0!==b[12]?f.child=new s(f,this.valueKey(b[12])):(this._index=b.index,f.parse()),I.lastIndex=this._index;return g}function f(a){var b;if(a.next("&")){if(b=d(a,this.node),!b)throw new B}else if(a.next("|")){if(b=d(a,this.node))throw this.reason.eventTrigger({action:"success",args:b}),new B}else a.exec(this.node)}function g(){}function h(a,b){b||(this._reason=a),this._parent=b,this.condition=[]}function i(a){this._parent=a}function j(a){var b;N.lastIndex=this._index;var c=N.exec(this._path);if(c){if(this._index=N.lastIndex,void 0!==c[1])b=new n(a).parse();else if(void 0!==c[2])b=new m(a,c[2]).parse();else if(void 0!==c[3])b=new o(a,c[3]).parse();else if(void 0!==c[4])b=new p(a,c[4]).parse();else if(void 0!==c[5])b=new o(a,this.valueKey(c[5])).parse();else if(void 0!==c[6])b=q.call(this,a);else{if(void 0===c[7])return void(this._index=c.index);b=new k(a).parse()}return b}}function k(a){this._parent=a}function l(a,b,c){try{return this._("config")[a](b)}catch(d){return b||c}}function m(a,b){this._parent=a,P.test(b)?(b=P.exec(b),this._start=b[1],this._limit=b[2]):this._start=b}function n(a){this._parent=a}function o(a,b){Object.defineProperty(this,"_parent",{value:a}),this._attr=b}function p(a,b){this._parent=a,this._type=b}function q(a){var b,c;if(a instanceof r||(c=new r(a)),W.lastIndex=this._index,b=W.exec(this._path),!b)return c;if(this._index=W.lastIndex,void 0!==b[1])c=new r(a);else{if(void 0===b[2])return this._index=b.index,c;c=new r(a,b[2]),b[3]&&b[3].length>0&&(c._args=JSON.parse("["+b[3]+"]"))}return c.parse()}function r(a,b){this._parent=a,this._name=b}function s(a,b){this._parent=a,this._value=b}function t(a){if(this.child)return this.child.exec(a);var b=this.reason();if(!((b._count+=1)<=b._start)){var c=b.eventPicker({cache:b,action:"complete",empty:!0});if(b.eventTrigger({action:"success",args:a}),c.Note({data:a}),c.Talk(),-1!==b._limit&&c._note.Length()>=b._limit)throw c.Talk(),new C}}function u(a){var b=e.call(a);try{b.exec(this)}catch(c){if(c instanceof C)return;if(void 0!==a._preset)return void a.eventTrigger({action:"success",args:a._preset});if(c instanceof B)return;throw new Error(c)}}function v(a){this._path=a.path,this._values=a.values,this._preset=a.preset,this._limit=a.limit,this._start=a.start,this._async=a.async,this._count=0,this._index=0}function w(a){var b;return a=a||"",a.xType("String")&&(a={path:a}),a.limit=1,a.async=!1,a.success=function(a){b=a},this.pathFind(a),A.call(b,"Undefined")&&(b=A.call(a.preset,"Function")?a.preset.call(this):a.preset),b}function x(c){var d;c=c||{},d=c.self||this,c.limit=c.limit||-1,c.start=c.start||0,c.values=c.values||{},c.values.self=c.values.self||this;var e=new v(c);return a.defineEvent(e),b(c.success)&&e.eventListener({action:"success",self:d,listen:c.success}),b(c.complete)&&e.eventListener({action:"complete",self:d,listen:c.complete}),z(this,u,e,c.async),this}function y(a){return void 0!==this.pathNode({path:a})}var z=a.utilTick,A=a.type,B=a.ns("util.control.Break"),C=a.ns("util.control.End"),D=/\\"/g,E=/\\'/g,F={">":function(a,b){return a>b},"<":function(a,b){return b>a},">=":function(a,b){return a>=b},"<=":function(a,b){return b>=a},"==":function(a,b){return a===b},"!=":function(a,b){return a!==b}},G={"*":function(a){a.xEach({self:this,success:function(a){t.call(this,a)}})},"+":function(a){this.child&&(this._specific=this.child.filter),d(this.specific(),a)&&this.child.exec(a)},"#":function(a){var b=this.specific(),c=b?d(b,a):!0;c&&(this.child.exec(a),(A.call(a,"Array")||A.call(a,"Object"))&&a.xEach({self:this,success:function(a){G["#"].call(this,a)}}))}},H='\\s*(?:(\\!=|[<>=]{1,2})|(\\!+)|(&|\\|)|(\\[|\\()|(\\]|\\))\\.?|(-?\\d+(?:\\.\\d+)?)(?![\\.:~\\d])|(true|false)|"((?:[^"\\\\]*|\\\\"|\\\\)*)"|'+"'((?:[^'\\\\]*|\\\\'|\\\\)*)'|\\/((?:[^\\/\\\\]*|\\\\\\/|\\\\)+)\\/([igm]{1,3})?|\\$([\\w]+)|.+)\\s*",I=new RegExp(H,"g"),J=0;g.prototype={parent:function(a){return a?this._parent&&b(this._parent[a])&&this._parent[a]():this._parent},reason:function(){return this._reason||this.parent("reason")},specific:function(){return this._specific||this.parent("specific")}};var K=h.prototype=new g;K.add=function(a){var b=new i(this);return a&&this.condition.push(b),b},K.exec=function(a){var b=this.reason(),c=b.eventPicker({cache:b,action:"complete",empty:!0});this.condition.xEach({self:{node:a,reason:b},success:f}),c.Talk()};var L=i.prototype=new g;L.parse=function(){return this.child=j.call(this.reason(),this),this},L.exec=function(a){var b,e;return this.reverse()||this.operator()?(b=d(this.child,a),b=c(this.reverse(),b),this.operator()&&(e=d(this.value,a),e instanceof RegExp&&(b=e.test(b),e=!0),b=F[this.operator()](b,e)),void this.reason().eventTrigger({action:"success",args:b})):t.call(this,a)},L.reverse=function(){return this._reverse||0},L.operator=function(){return this._operator||0},L.next=function(a){return a?this._next===a:this._next};var M="\\s*(?:(\\.)|(-?\\d*~\\d*|-\\d+)\\.?|(\\d+|[a-z][a-z\\d\\-]*)\\.?|([*#+])\\.?|\\$([a-z\\d_]+)\\.?|(:)|(\\[|\\()|.+)\\s*",N=new RegExp(M,"g"),O=k.prototype=new g;O.parse=function(){return this.filter=e.call(this.reason(),this),this.child=j.call(this.reason(),this),this},O.exec=function(a){return d(this.filter,a)?(t.call(this,a),!0):void 0};var P=/^(-?\d+)?~(\d+)?$/,Q=m.prototype=new g;Q.parse=function(){return this.child=j.call(this.reason(),this),this},Q.exec=function(a){a.xEach({self:this,start:l.call(a,"optStart",this._start,0),limit:l.call(a,"optLimit",this._limit,10),success:function(a){t.call(this,a)}})};var R=n.prototype=new g;R.parse=function(){return this.child=j.call(this.reason(),this),this},R.exec=function(a){t.call(this,a.__parent__)};var S=o.prototype=new g;S.parse=function(){return this.child=j.call(this.reason(),this),this},S.exec=function(a){a[this.attr()]&&(a=a[this.attr()],t.call(this,a))},S.attr=function(){return this._attr};var T=p.prototype=new g;T.parse=function(){return this.child=j.call(this.reason(),this),this},T.exec=function(a){G[this.type()].call(this,a)},T.type=function(){return this._type};var U="(?:[^)\\\\]*|\\\\\\)|\\\\)+",V="(?:(\\.)|(\\w+)(?:\\(("+U+")\\))?\\.?)\\s*|.+",W=new RegExp(V,"g"),X=r.prototype=new g;X.parse=function(){return this.child=q.call(this.reason(),this),this},X.exec=function(a){b(a[this.name()])&&(a=a[this.name()].apply(a,this.args()),t.call(this,a))},X.name=function(){return this._name||"toString"},X.args=function(){return this._args};var Y=s.prototype=new g;Y.exec=function(){t.call(this,this._value)},v.prototype={valueKey:function(a){return this._values[a]}},a.ns("util.path").prototypes={pathNode:w,pathFind:x,pathExists:y},a.definePath=function(a){Object.defineProperties(a,{pathNode:{value:w},pathFind:{value:x},pathExists:{value:y}})}}(Crisp);