/*! OpenCrisp PathJS - v0.1.0 - 2015-07-24
* http://opencrisp.wca.at
* Copyright (c) 2015 Fabian Schmid; Licensed MIT */
!function(a){function b(a){return u(a,"Function")}function c(a,b){for(var c=0;a>c;c+=1)b="false"===b||b===!1?!0:!b;return b}function d(b,c){var d;if(b)return b._reason={},a.defineEvent(b._reason),b._reason.eventListener({limit:1,action:"success",listen:function(a){d=a.data}}),b.exec(c),d}function e(a){var b,c,d,f,h=new g(this,a);for(f=d=h.add(1),this.level+=1,C.lastIndex=this.index;!c&&(b=C.exec(this.path));)this.index=C.lastIndex,D+=1,void 0!==b[1]?(f._operator=b[1],f=f.value=h.add()):void 0!==b[2]?f._reverse=b[2].length:void 0!==b[3]?(d._next=b[3],f=d=h.add(1)):void 0!==b[4]?f.child=e.call(this,f):void 0!==b[5]?c=!0:void 0!==b[6]?f.child=new p(f,Number(b[6])):void 0!==b[7]?f.child=new p(f,"true"===b[7]):void 0!==b[8]?f.child=new p(f,b[8].replace(x,'"')):void 0!==b[9]?f.child=new p(f,b[9].replace(y,"'")):void 0!==b[10]?f.child=new p(f,new RegExp(b[10],b[11])):void 0!==b[12]?f.child=new p(f,this.valueKey(b[12])):(this.index=b.index,f.parse()),C.lastIndex=this.index;return this.level-=1,h}function f(a){var b;if(a.next("&")){if(b=d(a,this.node),!b)throw new v}else if(a.next("|")){if(b=d(a,this.node))throw this.reason.eventTrigger({action:"success",args:b}),new v}else a.exec(this.node)}function g(a,b){b||(this._reason=a),Object.defineProperty(this,"_parent",{value:b}),this.condition=[]}function h(a){Object.defineProperty(this,"_parent",{value:a})}function i(a){var b;F.lastIndex=this.index;var c=F.exec(this.path);if(c){if(this.index=F.lastIndex,void 0!==c[1])b=new k(a).parse();else if(void 0!==c[2])b=new l(a,c[2]).parse();else if(void 0!==c[3])b=new m(a,c[3]).parse();else if(void 0!==c[4])b=new l(a,this.valueKey(c[4])).parse();else if(void 0!==c[5])b=n.call(this,a);else{if(void 0===c[6])return void(this.index=c.index);b=new j(a).parse()}return b}}function j(a){Object.defineProperty(this,"_parent",{value:a})}function k(a){Object.defineProperty(this,"_parent",{value:a})}function l(a,b){Object.defineProperty(this,"_parent",{value:a}),this._attr=b}function m(a,b){Object.defineProperty(this,"_parent",{value:a}),this._type=b}function n(a){var b,c;if(a instanceof o||(c=new o(a)),I.lastIndex=this.index,b=I.exec(this.path),!b)return c;if(this.index=I.lastIndex,void 0!==b[1])c=new o(a);else{if(void 0===b[2])return this.index=b.index,c;c=new o(a,b[2]),b[3]&&b[3].length>0&&(c._args=JSON.parse("["+b[3]+"]"))}return c.parse()}function o(a,b){Object.defineProperty(this,"_parent",{value:a}),this._name=b}function p(a,b){Object.defineProperty(this,"_parent",{value:a}),this._value=b}function q(a){if(this.child)return this.child.exec(a);var b=this.reason(),c=b.eventPicker({cache:b,action:"complete"});if(b.eventTrigger({action:"success",args:a}),c.Note({data:a}),c.Talk(),-1!==b.limit&&c.note.Length()>=b.limit)throw c.Talk(),new w}function r(a){var b=e.call(a);try{b.exec(this)}catch(c){if(c instanceof w)return;if(void 0!==a.preset)return void a.eventTrigger({action:"success",args:a.preset});if(c instanceof v)return;throw new Error(c)}}function s(a){this.index=a.index,this.path=a.path,this.values=a.values,this.preset=a.preset,this.limit=a.limit,this.async=a.async,this.level=a.level,this.filter=a.filter}var t=a.utilTick,u=a.isType,v=a.ns("util.control.Break"),w=a.ns("util.control.End"),x=/\\"/g,y=/\\'/g,z={">":function(a,b){return a>b},"<":function(a,b){return b>a},">=":function(a,b){return a>=b},"<=":function(a,b){return b>=a},"==":function(a,b){return a===b},"!=":function(a,b){return a!==b}},A={"*":function(a){a.xEach({self:this,success:function(a){q.call(this,a)}})},"+":function(a){this.child&&(this._specific=this.child.filter),d(this.specific(),a)&&this.child.exec(a)},"#":function(a){var b=this.specific(),c=b?d(b,a):!0;c&&(this.child.exec(a),u(a.xEach,"Function")&&a.xEach({self:this,success:function(a){A["#"].call(this,a)}}))}},B='\\s*(?:(\\!=|[<>=]{1,2})|(\\!+)|(&|\\|)|(\\[|\\()|(\\]|\\))\\.?|([0-9]+(?:\\.[0-9]+)?)(?!\\.|:)|(true|false)|"((?:[^"\\\\]*|\\\\"|\\\\)*)"|'+"'((?:[^'\\\\]*|\\\\'|\\\\)*)'|\\/((?:[^\\/\\\\]*|\\\\\\/|\\\\)+)\\/([igm]{1,3})?|\\$([\\w]+)|.+)\\s*",C=new RegExp(B,"g"),D=0;g.prototype={parent:function(a){return a?this._parent&&b(this._parent[a])&&this._parent[a]():this._parent},reason:function(){return this._reason||this.parent("reason")},specific:function(){return this._specific||this.parent("specific")},add:function(a){var b=new h(this);return a&&this.condition.push(b),b},exec:function(a){var b=this.reason(),c=b.eventPicker({cache:b,action:"complete"});this.condition.xEach({self:{node:a,reason:b},success:f}),c.Talk()}},h.prototype={parent:function(a){return a?this._parent&&b(this._parent[a])&&this._parent[a]():this._parent},reason:function(){return this._reason||this.parent("reason")},specific:function(){return this._specific||this.parent("specific")},parse:function(){return this.child=i.call(this.reason(),this),this},exec:function(a){var b,e;return this.reverse()||this.operator()?(b=d(this.child,a),b=c(this.reverse(),b),this.operator()&&(e=d(this.value,a),e instanceof RegExp&&(b=e.test(b),e=!0),b=z[this.operator()](b,e)),void this.reason().eventTrigger({action:"success",args:b})):q.call(this,a)},reverse:function(){return this._reverse||0},operator:function(){return this._operator||0},next:function(a){return a?this._next===a:this._next}};var E="\\s*(?:(\\.)|([0-9]+|[a-z][a-z0-9\\-]*)\\.?|([*#+])\\.?|\\$([a-z0-9_]+)\\.?|(:)|(\\[|\\()|.+)\\s*",F=new RegExp(E,"g");j.prototype={parent:function(a){return a?this._parent&&b(this._parent[a])&&this._parent[a]():this._parent},reason:function(){return this._reason||this.parent("reason")},specific:function(){return this._specific||this.parent("specific")},parse:function(){return this.filter=e.call(this.reason(),this),this.child=i.call(this.reason(),this),this},exec:function(a){return d(this.filter,a)?(q.call(this,a),!0):void 0}},k.prototype={parent:function(a){return a?this._parent&&b(this._parent[a])&&this._parent[a]():this._parent},reason:function(){return this._reason||this.parent("reason")},specific:function(){return this._specific||this.parent("specific")},parse:function(){return this.child=i.call(this.reason(),this),this},exec:function(a){q.call(this,a.__parent__)}},l.prototype={parent:function(a){return a?this._parent&&b(this._parent[a])&&this._parent[a]():this._parent},reason:function(){return this._reason||this.parent("reason")},specific:function(){return this._specific||this.parent("specific")},parse:function(){return this.child=i.call(this.reason(),this),this},exec:function(a){a[this.attr()]&&(a=a[this.attr()],q.call(this,a))},attr:function(){return this._attr}},m.prototype={parent:function(a){return a?this._parent&&b(this._parent[a])&&this._parent[a]():this._parent},reason:function(){return this._reason||this.parent("reason")},specific:function(){return this._specific||this.parent("specific")},parse:function(){return this.child=i.call(this.reason(),this),this},exec:function(a){A[this.type()].call(this,a)},type:function(){return this._type}};var G="(?:[^)\\\\]*|\\\\\\)|\\\\)+",H="(?:(\\.)|(\\w+)(?:\\(("+G+")\\))?\\.?)\\s*|.+",I=new RegExp(H,"g");o.prototype={parent:function(a){return a?this._parent&&b(this._parent[a])&&this._parent[a]():this._parent},reason:function(){return this._reason||this.parent("reason")},specific:function(){return this._specific||this.parent("specific")},parse:function(){return this.child=n.call(this.reason(),this),this},exec:function(a){if(!b(a[this.name()]))throw new Error("PathFunction "+this.name()+" is not defined!");a=a[this.name()].apply(a,this.args()),q.call(this,a)},name:function(){return this._name||"toString"},args:function(){return this._args}},p.prototype={parent:function(a){return a?this._parent&&b(this._parent[a])&&this._parent[a]():this._parent},reason:function(){return this._reason||this.parent("reason")},specific:function(){return this._specific||this.parent("specific")},exec:function(){q.call(this,this._value)}},s.prototype={valueKey:function(a){return this.values[a]}},a.definePath=function(c){Object.defineProperties(c,{pathNode:{value:function(a){var b,c=this;return a=a||"","[object String]"==={}.toString.call(a)&&(a={path:a}),a.limit=1,a.async=!1,a.success=function(a){b=a.data},c.pathFind(a),void 0===b&&(b=a.preset),b}},pathFind:{value:function(c){var d=this;c=c||{},c.limit=c.limit||-1,c.index=c.index||0,c.level=0;var e=new s(c);return a.defineEvent(e),b(c.success)&&e.eventListener({action:"success",self:d,listen:c.success}),b(c.complete)&&e.eventListener({action:"complete",self:d,listen:c.complete}),t(d,r,e),d}},pathExists:{value:function(a){return void 0!==this.pathNode({path:a})}}})}}(Crisp);