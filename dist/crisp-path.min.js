/*! OpenCrisp PathJS - v1.0.0 - 2015-12-26
* http://opencrisp.wca.at/docs/util.path.html
* Copyright (c) 2015 Fabian Schmid; Licensed MIT */
!function(a){function b(){}function c(a,b,c){var d=D.call(a.itemEach,"Function")?a.itemEach:a.xEach;c=c||function(a){w.call(this,a,null,b)},d.callback.call(a,{self:this,reverse:this._revlist},c)}function d(a,b){this.child.exec({node:a},b),(D.call(a,"Array")||D.call(a,"Object"))&&c.call(this,a,b,function(a){J["#"].call(this,a,b)})}function e(a){return D.call(a,"Function")}function f(c,d,e,f){var g=this;if(c){var h={};a.defineEvent(h),h.eventListener({action:"success",listen:function(a){e.call(g,a)}}),h.eventListener({action:"complete",listen:function(){f.call(g)}});try{c.exec({node:d},h)}catch(i){if(i instanceof b)return;if(i instanceof F)return;throw i}}}function g(a){var b,c,d,e,f=new i(this,a);for(e=d=f.add(1),L.lastIndex=this._index;!c&&(b=L.exec(this._path));)this._index=L.lastIndex,M+=1,void 0!==b[1]?(e._operator=b[1],e=e.value=f.add()):void 0!==b[2]?e._reverse=b[2].length:void 0!==b[3]?(d._next=b[3],e=d=f.add(1)):void 0!==b[4]?e.child=g.call(this,e):void 0!==b[5]?c=!0:void 0!==b[6]?e.child=new v(e,Number(b[6])):void 0!==b[7]?e.child=new v(e,"true"===b[7]):void 0!==b[8]?e.child=new v(e,b[8].replace(G,'"')):void 0!==b[9]?e.child=new v(e,b[9].replace(H,"'")):void 0!==b[10]?e.child=new v(e,new RegExp(b[10],b[11])):void 0!==b[12]?e.child=new v(e,this.valueKey(b[12])):(this._index=b.index,e.parse()),L.lastIndex=this._index;return f}function h(){}function i(a,b){b||(this._reason=a),this._parent=b,this.condition=[]}function j(a,b,c){var d=D.call(b,"Undefined")||"false"===b||b===!1||D.call(b,"Boolean")&&!b.valueOf();d?k.call(this,a,!0,c):D.call(b.isBoolean,"Function")?b.isBoolean.tick||k.call(this,a,b.isBoolean()&&!b.valueOf()||!b,c):k.call(this,a,!b,c)}function k(a,b,c){a>0?(a-=1,j.apply(this,arguments)):c.call(this,b)}function l(a,b,c,d){return a?void f.call(this,this.value,b,function(d){d instanceof RegExp&&(b=d.test(b),d=!0),b=I[a](b,d),c.call(this,b)},d):(c.call(this,b),void d.call(this))}function m(a){this._parent=a}function n(a){var b;Q.lastIndex=this._index;var c=Q.exec(this._path);if(c){if(this._index=Q.lastIndex,void 0!==c[1])b=new q(a).parse();else if(void 0!==c[3])b=new p(a,c[3]).parse(),b._revlist=c[2];else if(void 0!==c[4])b=new r(a,c[4]).parse();else if(void 0!==c[6])b=new s(a,c[6]).parse(),b._revlist=c[5];else if(void 0!==c[7])b=new r(a,this.valueKey(c[7])).parse(),b._valkey=c[7];else if(void 0!==c[8])b=t.call(this,a);else{if(void 0===c[9])return void(this._index=c.index);b=new o(a).parse()}return b}}function o(a){this._parent=a}function p(a,b){this._parent=a,S.test(b)?(b=S.exec(b),this._start=b[1],this._limit=b[2]):this._start=b}function q(a){this._parent=a}function r(a,b){Object.defineProperty(this,"_parent",{value:a}),this._attr=b}function s(a,b){this._parent=a,this._type=b}function t(a){var b,c;if(a instanceof u||(c=new u(a)),Z.lastIndex=this._index,b=Z.exec(this._path),!b)return c;if(this._index=Z.lastIndex,void 0!==b[1])c=new u(a);else{if(void 0===b[2])return this._index=b.index,c;c=new u(a,b[2]),b[3]&&b[3].length>0&&(c._args=JSON.parse("["+b[3].replace($,"$1")+"]"))}return c.parse()}function u(a,b){this._parent=a,this._name=b}function v(a,b){this._parent=a,this._value=b}function w(a,b,c){if(this.child)return void this.child.exec({node:a},c);var d=this.reason();if(!((d._count+=1)<=d._start)&&(c.eventTrigger({action:"success",args:[a]}),-1!==d._limit&&d._count>=d._limit))throw b=c.eventPicker({cache:c,action:"complete",empty:!0}),b.End(),new F}function x(a,b){var c=g.call(a);try{c.exec({node:this},b)}catch(d){if(d instanceof F)return;if(void 0!==a._preset)return void b.eventTrigger({action:"success",args:a._preset});throw d}}function y(a){this._path=a.path,this._values=a.values,this._preset=a.preset,this._limit=a.limit,this._start=a.start,this._async=a.async,this._count=0,this._index=0}function z(a){var b;return a=a||"",a.xType("String")&&(a={path:a}),a.limit=1,a.async=!1,a.success=function(a){b=a},this.pathFind(a),D.call(b,"Undefined")&&(b=D.call(a.preset,"Function")?a.preset.call(this):a.preset),b}function A(b,c,d){var f;b=b||{},c=c||b.success,d=d||b.complete,f=b.self||this,b.limit=b.limit||-1,b.start=b.start||0,b.values=b.values||{},b.values.self=b.values.self||this;var g=new y(b);g.level=0;var h={};return a.defineEvent(h),e(c)&&h.eventListener({action:"success",self:f,listen:c}),e(d)&&h.eventListener({action:"complete",self:f,listen:d}),C(this,x,[g,h],b.async),this}function B(a){return void 0!==this.pathNode({path:a})}var C=a.utilTick,D=a.type,E=a.ns("util.control.End"),F=function(){},G=/\\"/g,H=/\\'/g,I={">":function(a,b){return a>b},"<":function(a,b){return b>a},">=":function(a,b){return a>=b},"<=":function(a,b){return b>=a},"==":function(a,b){return a===b},"!=":function(a,b){return a!==b}},J={"*":c,"+":function(a,b){var c=b.eventPicker({cache:b,action:"complete",empty:!0});this.child&&(this._specific=this.child.filter),f.call(this,this.specific(),a,function(c){c&&this.child.exec({node:a},b)},function(){c.Talk()})},"#":function(a,b){var c=this.specific();c?f.call(this,c,a,function(c){c&&d.call(this,a,b)},E):d.call(this,a,b)}},K='\\s*(?:(\\!=|[<>=]{1,2})|(\\!+)|(&|\\|)|(\\[|\\()|(\\]|\\))\\.?|(-?\\d+(?:\\.\\d+)?)(?![\\.:~\\d])|(true|false)|"((?:[^"\\\\]*|\\\\"|\\\\)*)"|'+"'((?:[^'\\\\]*|\\\\'|\\\\)*)'|\\/((?:[^\\/\\\\]*|\\\\\\/|\\\\)+)\\/([igm]{1,3})?|\\$([\\w]+)\\s?(?![\\w\\.:])|.+)\\s*",L=new RegExp(K,"g"),M=0;h.prototype={parent:function(a){return a?this._parent&&e(this._parent[a])&&this._parent[a]():this._parent},reason:function(){return this._reason||this.parent("reason")},specific:function(){return this._specific||this.parent("specific")}};var N=i.prototype=new h;N.add=function(a){var b=new m(this);return a&&this.condition.push(b),b},N.exec=function(a,b){var c=b.eventPicker({cache:b,action:"complete",empty:!0});this.condition.xEach({self:this},function(d){return c.Wait(),d.next("&")?void f.call(this,d,a.node,function(a){if(!a)throw c.Talk(),new E},function(){c.Talk()}):d.next("|")?void f.call(this,d,a.node,function(a){if(a)throw w.call(this,a,c,b),c.Talk(),new E},function(){c.Talk()}):(d.exec({node:a.node},b),void c.Talk())},function(){c.Talk()})};var O=m.prototype=new h;O.parse=function(){return this.child=n.call(this.reason(),this),this},O.exec=function(a,b){var c=b.eventPicker({cache:b,action:"complete",empty:!0});return this.reverse()||this.operator()?void f.call(this,this.child,a.node,function(a){k.call(this,this.reverse(),a,function(a){c.Wait(),l.call(this,this.operator(),a,function(a){b.eventTrigger({action:"success",args:a})},function(){c.Talk()})})},function(){c.Talk()}):(w.call(this,a.node,c,b),void c.Talk())},O.reverse=function(){return this._reverse||0},O.operator=function(){return this._operator||0},O.next=function(a){return a?this._next===a:this._next};var P="\\s*(?:(\\.)|(\\^)?(-?\\d*~\\d*|-\\d+)\\.?|(\\d+|[a-z][a-z\\d\\-]*)\\.?|(\\^)?([*#+])\\.?|\\$([a-z\\d_]+)\\.?|(:)|(\\[|\\()|.+)\\s*",Q=new RegExp(P,"g"),R=o.prototype=new h;R.parse=function(){return this.filter=g.call(this.reason(),this),this.child=n.call(this.reason(),this),this},R.exec=function(a,b){var c=a.node,d=b.eventPicker({cache:b,action:"complete",empty:!0}),e=this;f.call(this,this.filter,c,function(a){a&&w.call(e,c,d,b)},function(){d.Talk()})};var S=/^(-?\d+)?~(\d+)?$/,T=p.prototype=new h;T.parse=function(){return this.child=n.call(this.reason(),this),this},T.exec=function(a,b){function c(a){var c=this.specific();c?f.call(this,c,a,function(c){c&&w.call(this,a,null,b)}):w.call(this,a,null,b)}var d,e=b.eventPicker({cache:b,action:"complete",empty:!0}),g={self:this,reverse:this._revlist};D.call(a.node.itemLimit,"Function")?(g.start=this._start,g.limit=this._limit,d=a.node.itemLimit):(g.start=this._start||0,g.limit=this._limit||10,d=a.node.xEach),d.callback.call(a.node,g,c),e.Talk()};var U=q.prototype=new h;U.parse=function(){return this.child=n.call(this.reason(),this),this},U.exec=function(a,b){w.call(this,a.node.__parent__,null,b)};var V=r.prototype=new h;V.parse=function(){return this.child=n.call(this.reason(),this),this},V.exec=function(a,b){var c=this,d=b.eventPicker({cache:b,action:"complete",empty:!0});return D.call(a.node[this.attr()],"Undefined")?this._valkey?(a.node=this.child.exec({node:this.attr()},b),void d.Talk()):D.call(a.node.pathInclude,"Function")?void a.node.pathInclude(this.attr(),function(a){w.call(c,a,d,b),d.Talk()}):void d.Talk():(w.call(this,a.node[this.attr()],d,b),void d.Talk())},V.attr=function(){return this._attr};var W=s.prototype=new h;W.parse=function(){return this.child=n.call(this.reason(),this),this},W.exec=function(a,b){J[this.type()].call(this,a.node,b)},W.type=function(){return this._type};var X="(?:[^)\\\\]*|\\\\\\)|\\\\)+",Y="(?:(\\.)|(\\w+)(?:\\(("+X+")\\))?\\.?)\\s*|.+",Z=new RegExp(Y,"g"),$=/\\([\(\)])/g,_=u.prototype=new h;_.parse=function(){return this.child=t.call(this.reason(),this),this},_.exec=function(b,c){function d(a){w.call(i,a,h,c)}function f(){h.Talk()}var g,h,i=this,j=b.node[this.name()];if(e(j)){if(h=c.eventPicker({cache:c,action:"complete",empty:!0}),!j.tick)return b.node=j.apply(b.node,this.args()),w.call(this,b.node,h,c),void h.Talk();g=a.callSchema(j.schema||j.tick,this.args()),j.call(b.node,g,d,f,h)}},_.name=function(){return this._name||"toString"},_.args=function(){return[].xAdd(this._args)};var aa=v.prototype=new h;aa.exec=function(a,b){var c=b.eventPicker({cache:b,action:"complete",empty:!0});w.call(this,this._value,c,b),c.Talk()},y.prototype={valueKey:function(a){return this._values[a]}},a.ns("util.path").prototypes={pathNode:z,pathFind:A,pathExists:B},a.definePath=function(a){Object.defineProperties(a,{pathNode:{value:z},pathFind:{value:A},pathExists:{value:B}})}}(Crisp);