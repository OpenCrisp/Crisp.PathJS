/*! OpenCrisp PathJS - v0.2.1 - 2015-08-12
* http://opencrisp.wca.at
* Copyright (c) 2015 Fabian Schmid; Licensed MIT */
!function(a){function b(a){return z(a,"Function")}function c(a,b){for(var c=0;a>c;c+=1)b="false"===b||b===!1?!0:!b;return b}function d(b,c){var d;if(b)return b._reason={},a.defineEvent(b._reason),b._reason.eventListener({limit:1,action:"success",listen:function(a){d=a}}),b.exec(c),d}function e(a){var b,c,d,f,g=new h(this,a);for(f=d=g.add(1),H.lastIndex=this._index;!c&&(b=H.exec(this._path));)this._index=H.lastIndex,I+=1,void 0!==b[1]?(f._operator=b[1],f=f.value=g.add()):void 0!==b[2]?f._reverse=b[2].length:void 0!==b[3]?(d._next=b[3],f=d=g.add(1)):void 0!==b[4]?f.child=e.call(this,f):void 0!==b[5]?c=!0:void 0!==b[6]?f.child=new r(f,Number(b[6])):void 0!==b[7]?f.child=new r(f,"true"===b[7]):void 0!==b[8]?f.child=new r(f,b[8].replace(C,'"')):void 0!==b[9]?f.child=new r(f,b[9].replace(D,"'")):void 0!==b[10]?f.child=new r(f,new RegExp(b[10],b[11])):void 0!==b[12]?f.child=new r(f,this.valueKey(b[12])):(this._index=b.index,f.parse()),H.lastIndex=this._index;return g}function f(a){var b;if(a.next("&")){if(b=d(a,this.node),!b)throw new A}else if(a.next("|")){if(b=d(a,this.node))throw this.reason.eventTrigger({action:"success",args:b}),new A}else a.exec(this.node)}function g(){}function h(a,b){b||(this._reason=a),this._parent=b,this.condition=[]}function i(a){this._parent=a}function j(a){var b;M.lastIndex=this._index;var c=M.exec(this._path);if(c){if(this._index=M.lastIndex,void 0!==c[1])b=new m(a).parse();else if(void 0!==c[2]||void 0!==c[4])b=new l(a,c[2]||c[4],c[3]).parse();else if(void 0!==c[5])b=new n(a,c[5]).parse();else if(void 0!==c[6])b=new o(a,c[6]).parse();else if(void 0!==c[7])b=new n(a,this.valueKey(c[7])).parse();else if(void 0!==c[8])b=p.call(this,a);else{if(void 0===c[9])return void(this._index=c.index);b=new k(a).parse()}return b}}function k(a){this._parent=a}function l(a,b,c){this._parent=a,this._start=Number(b),this._limit=c&&Math.abs(c)}function m(a){this._parent=a}function n(a,b){Object.defineProperty(this,"_parent",{value:a}),this._attr=b}function o(a,b){this._parent=a,this._type=b}function p(a){var b,c;if(a instanceof q||(c=new q(a)),U.lastIndex=this._index,b=U.exec(this._path),!b)return c;if(this._index=U.lastIndex,void 0!==b[1])c=new q(a);else{if(void 0===b[2])return this._index=b.index,c;c=new q(a,b[2]),b[3]&&b[3].length>0&&(c._args=JSON.parse("["+b[3]+"]"))}return c.parse()}function q(a,b){this._parent=a,this._name=b}function r(a,b){this._parent=a,this._value=b}function s(a){if(this.child)return this.child.exec(a);var b=this.reason(),c=b.eventPicker({cache:b,action:"complete",empty:!0});if(b.eventTrigger({action:"success",args:a}),c.Note({data:a}),c.Talk(),-1!==b._limit&&c._note.Length()>=b._limit)throw c.Talk(),new B}function t(a){var b=e.call(a);try{b.exec(this)}catch(c){if(c instanceof B)return;if(void 0!==a._preset)return void a.eventTrigger({action:"success",args:a._preset});if(c instanceof A)return;throw new Error(c)}}function u(a){this._index=a.index,this._path=a.path,this._values=a.values,this._preset=a.preset,this._limit=a.limit,this._async=a.async}function v(a){var b;return a=a||"",a.xType("String")&&(a={path:a}),a.limit=1,a.async=!1,a.success=function(a){b=a},this.pathFind(a),void 0===b&&(b=a.preset),b}function w(c){c=c||{},c.limit=c.limit||-1,c.index=c.index||0;var d=new u(c);return a.defineEvent(d),b(c.success)&&d.eventListener({action:"success",self:this,listen:c.success}),b(c.complete)&&d.eventListener({action:"complete",self:this,listen:c.complete}),y(this,t,d,c.async),this}function x(a){return void 0!==this.pathNode({path:a})}var y=a.utilTick,z=a.isType,A=a.ns("util.control.Break"),B=a.ns("util.control.End"),C=/\\"/g,D=/\\'/g,E={">":function(a,b){return a>b},"<":function(a,b){return b>a},">=":function(a,b){return a>=b},"<=":function(a,b){return b>=a},"==":function(a,b){return a===b},"!=":function(a,b){return a!==b}},F={"*":function(a){a.xEach({self:this,success:function(a){s.call(this,a)}})},"+":function(a){this.child&&(this._specific=this.child.filter),d(this.specific(),a)&&this.child.exec(a)},"#":function(a){var b=this.specific(),c=b?d(b,a):!0;c&&(this.child.exec(a),(z(a,"Array")||z(a,"Object"))&&a.xEach({self:this,success:function(a){F["#"].call(this,a)}}))}},G='\\s*(?:(\\!=|[<>=]{1,2})|(\\!+)|(&|\\|)|(\\[|\\()|(\\]|\\))\\.?|([0-9]+(?:\\.[0-9]+)?)(?!\\.|:)|(true|false)|"((?:[^"\\\\]*|\\\\"|\\\\)*)"|'+"'((?:[^'\\\\]*|\\\\'|\\\\)*)'|\\/((?:[^\\/\\\\]*|\\\\\\/|\\\\)+)\\/([igm]{1,3})?|\\$([\\w]+)|.+)\\s*",H=new RegExp(G,"g"),I=0;g.prototype={parent:function(a){return a?this._parent&&b(this._parent[a])&&this._parent[a]():this._parent},reason:function(){return this._reason||this.parent("reason")},specific:function(){return this._specific||this.parent("specific")}};var J=h.prototype=new g;J.add=function(a){var b=new i(this);return a&&this.condition.push(b),b},J.exec=function(a){var b=this.reason(),c=b.eventPicker({cache:b,action:"complete",empty:!0});this.condition.xEach({self:{node:a,reason:b},success:f}),c.Talk()};var K=i.prototype=new g;K.parse=function(){return this.child=j.call(this.reason(),this),this},K.exec=function(a){var b,e;return this.reverse()||this.operator()?(b=d(this.child,a),b=c(this.reverse(),b),this.operator()&&(e=d(this.value,a),e instanceof RegExp&&(b=e.test(b),e=!0),b=E[this.operator()](b,e)),void this.reason().eventTrigger({action:"success",args:b})):s.call(this,a)},K.reverse=function(){return this._reverse||0},K.operator=function(){return this._operator||0},K.next=function(a){return a?this._next===a:this._next};var L="\\s*(?:(\\.)|(?:(-?[0-9]+)~([0-9]+)|(-[0-9]+))\\.?|([0-9]+|[a-z][a-z0-9\\-]*)\\.?|([*#+])\\.?|\\$([a-z0-9_]+)\\.?|(:)|(\\[|\\()|.+)\\s*",M=new RegExp(L,"g"),N=k.prototype=new g;N.parse=function(){return this.filter=e.call(this.reason(),this),this.child=j.call(this.reason(),this),this},N.exec=function(a){return d(this.filter,a)?(s.call(this,a),!0):void 0};var O=l.prototype=new g;O.parse=function(){return this.child=j.call(this.reason(),this),this},O.exec=function(a){a.xEach({self:this,start:this._start,limit:this._limit,success:function(a){s.call(this,a)}})};var P=m.prototype=new g;P.parse=function(){return this.child=j.call(this.reason(),this),this},P.exec=function(a){s.call(this,a.__parent__)};var Q=n.prototype=new g;Q.parse=function(){return this.child=j.call(this.reason(),this),this},Q.exec=function(a){a[this.attr()]&&(a=a[this.attr()],s.call(this,a))},Q.attr=function(){return this._attr};var R=o.prototype=new g;R.parse=function(){return this.child=j.call(this.reason(),this),this},R.exec=function(a){F[this.type()].call(this,a)},R.type=function(){return this._type};var S="(?:[^)\\\\]*|\\\\\\)|\\\\)+",T="(?:(\\.)|(\\w+)(?:\\(("+S+")\\))?\\.?)\\s*|.+",U=new RegExp(T,"g"),V=q.prototype=new g;V.parse=function(){return this.child=p.call(this.reason(),this),this},V.exec=function(a){if(!b(a[this.name()]))throw new Error("PathFunction "+this.name()+" is not defined!");a=a[this.name()].apply(a,this.args()),s.call(this,a)},V.name=function(){return this._name||"toString"},V.args=function(){return this._args};var W=r.prototype=new g;W.exec=function(){s.call(this,this._value)},u.prototype={valueKey:function(a){return this._values[a]}},a.ns("util.path").prototypes={pathNode:v,pathFind:w,pathExists:x},a.definePath=function(a){Object.defineProperties(a,{pathNode:{value:v},pathFind:{value:w},pathExists:{value:x}})}}(Crisp);