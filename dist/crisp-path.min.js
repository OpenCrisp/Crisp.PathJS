/*! OpenCrisp PathJS - v1.2.0 - 2016-03-03
* http://opencrisp.wca.at/docs/util.path.html
* Copyright (c) 2016 Fabian Schmid; Licensed MIT */
!function(a){function b(){}function c(){}function d(a,b,c){var d=E.call(a.itemEach,"Function")?a.itemEach:a.xEach,e=this;c=c||function(a){x.call(this,a,null,b)},d.callback.call(a,{self:this,reverse:this._revlist},function(){c.apply(e,arguments)})}function e(a,b){this.child&&this.child.exec({node:a},b),(E.call(a,"Array")||E.call(a,"Object"))&&(a.isField&&a.isField()||d.call(this,a,b,function(a){K["#"].call(this,a,b)}))}function f(a){return E.call(a,"Function")}function g(b,c,d,e){if(b){var f={};a.defineEvent(f),f.eventListener({self:this,action:"success",listen:d}),f.eventListener({self:this,action:"complete",listen:e}),b.exec({node:c},f)}}function h(a){var b,c,d,e,f=new j(this,a);for(e=d=f.add(1),M.lastIndex=this._index;!c&&(b=M.exec(this._path));)this._index=M.lastIndex,N+=1,void 0!==b[1]?(e._operator=b[1],e=e.value=f.add()):void 0!==b[2]?e._reverse=b[2].length:void 0!==b[3]?(d._next=b[3],e=d=f.add(1)):void 0!==b[4]?e.child=h.call(this,e):void 0!==b[5]?c=!0:void 0!==b[6]?e.child=new w(e,Number(b[6])):void 0!==b[7]?e.child=new w(e,"true"===b[7]):void 0!==b[8]?e.child=new w(e,b[8].replace(H,'"')):void 0!==b[9]?e.child=new w(e,b[9].replace(I,"'")):void 0!==b[10]?e.child=new w(e,new RegExp(b[10],b[11])):void 0!==b[12]?e.child=new w(e,this._values,b[12]):(this._index=b.index,e.parse()),M.lastIndex=this._index;return f}function i(){}function j(a,b){b||(this._reason=a),this._parent=b,this.condition=[]}function k(a,b,c){var d=E.call(b,"Undefined")||"false"===b||b===!1||E.call(b,"Boolean")&&!b.valueOf();d?l.call(this,a,!0,c):E.call(b.isBoolean,"Function")?b.isBoolean.tick||l.call(this,a,b.isBoolean()&&!b.valueOf()||!b,c):l.call(this,a,!b,c)}function l(a,b,c){a>0?(a-=1,k.apply(this,arguments)):c.call(this,b)}function m(a,b,c,d,e){return a?void g.call(this,this.value,c,function(c){c instanceof RegExp&&(b=c.test(b),c=!0),b=J[a](b,c),d.call(this,b)},e):(d.call(this,b),void e.call(this))}function n(a){this._parent=a}function o(a){var b;R.lastIndex=this._index;var c=R.exec(this._path);if(!c)return new s(a);if(this._index=R.lastIndex,void 0!==c[1])b=new r(a).parse();else if(void 0!==c[3])b=new q(a,c[3]).parse(),b._revlist=c[2];else if(void 0!==c[4])b=new s(a,c[4]).parse();else if(void 0!==c[6])b=new t(a,c[6]).parse(),b._revlist=c[5];else if(void 0!==c[7])b=new s(a,this.valueKey(c[7])).parse(),b._valkey=c[7];else if(void 0!==c[8])b=u.call(this,a);else{if(void 0===c[9])return void(this._index=c.index);b=new p(a).parse()}return b}function p(a){this._parent=a}function q(a,b){this._parent=a,T.test(b)?(b=T.exec(b),this._start=b[1],this._limit=b[2]):this._start=b}function r(a){this._parent=a}function s(a,b){Object.defineProperty(this,"_parent",{value:a}),this._attr=b}function t(a,b){this._parent=a,this._type=b}function u(a){var b,c;if(a instanceof v||(c=new v(a)),$.lastIndex=this._index,b=$.exec(this._path),!b)return c;if(this._index=$.lastIndex,void 0!==b[1])c=new v(a);else{if(void 0===b[2])return this._index=b.index,c;c=new v(a,b[2]),b[3]&&b[3].length>0&&(c._args=JSON.parse("["+b[3].replace(_,"$1")+"]"))}return c.parse()}function v(a,b){this._parent=a,this._name=b}function w(a,b,c){this._parent=a,this._value=b,this._key=c}function x(a,b,d){if(this.child)return void this.child.exec({node:a},d);var e=this.reason();if(!((e._count+=1)<=e._start)&&(d.eventTrigger({action:"success",args:[a]}),-1!==e._limit&&e._count>=e._limit))throw b=d.eventPicker({cache:d,action:"complete",empty:!0}),b.End(),new c}function y(a,b){var d=h.call(a);try{d.exec({node:this},b)}catch(e){if(e instanceof c)return;if(void 0!==a._preset)return void b.eventTrigger({action:"success",args:a._preset});if(e instanceof F)return;throw e}}function z(a){this._path=a.path,this._values=a.values,this._preset=a.preset,this._limit=a.limit,this._start=a.start,this._async=a.async,this._count=0,this._index=0}function A(a){var b;return a=a||"",a.xType("String")&&(a={path:a}),a.limit=1,a.async=!1,a.success=function(a){b=a},this.pathFind(a),E.call(b,"Undefined")&&(b=E.call(a.preset,"Function")?a.preset.call(this):a.preset),b}function B(b,c,d){var e;b=b||{},c=c||b.success,d=d||b.complete,e=b.self||this,b.limit=b.limit||-1,b.start=b.start||0,b.values=b.values||{},b.values.self=b.values.self||this,b.values.root=b.values.root||function(){return this.rootSelf()};var g=new z(b);g.level=0;var h={};return a.defineEvent(h),f(c)&&h.eventListener({action:"success",self:e,listen:c}),f(d)&&h.eventListener({action:"complete",self:e,listen:d}),D(this,y,[g,h],b.async),this}function C(a){return void 0!==this.pathNode({path:a})}var D=a.utilTick,E=a.type,F=a.ns("util.control.Break"),G=a.ns("util.control.End"),H=/\\"/g,I=/\\'/g,J={">":function(a,b){return a>b},"<":function(a,b){return b>a},">=":function(a,b){return a>=b},"<=":function(a,b){return b>=a},"==":function(a,b){return a===b},"!=":function(a,b){return a!==b}},K={"*":function(a,c){var e=this.specific();d.call(this,a,c,function(a){if(e)try{g.call(this,e,a,function(d){if(!d)throw new b;this.child.exec({node:a},c)},G)}catch(d){if(d instanceof b)throw new F}else this.child.exec({node:a},c)})},"+":function(a,b){this.child&&(this._specific=this.child.filter),x.call(this.child,a,null,b)},"#":function(a,b){var c=this.specific();c?g.call(this,c,a,function(c){c&&e.call(this,a,b)},G):e.call(this,a,b)}},L='\\s*(?:(\\!=|[<>=]{1,2})|(\\!+)|(&|\\|)|(\\[|\\()|(\\]|\\))\\.?|(-?\\d+(?:\\.\\d+)?)(?![\\.:~\\d])|(true|false)|"((?:[^"\\\\]*|\\\\"|\\\\)*)"|'+"'((?:[^'\\\\]*|\\\\'|\\\\)*)'|\\/((?:[^\\/\\\\]*|\\\\\\/|\\\\)+)\\/([igm]{1,3})?|\\$([\\w]+)\\s?(?![\\w\\.:])|.+)\\s*",M=new RegExp(L,"g"),N=0;i.prototype={parent:function(a){return a?this._parent&&f(this._parent[a])&&this._parent[a]():this._parent},reason:function(){return this._reason||this.parent("reason")},specific:function(){return null!==this._specific?this._specific||this.parent("specific"):void 0}};var O=j.prototype=new i;O.add=function(a){var b=new n(this);return a&&this.condition.push(b),b},O.exec=function(a,b){var c=b.eventPicker({cache:b,action:"complete",empty:!0});this.condition.xEach({self:this},function(d){return c.Wait(),d.next("&")?void g.call(this,d,a.node,function(a){if(!a)throw c.Talk(),new G},function(){c.Talk()}):d.next("|")?void g.call(this,d,a.node,function(a){if(a)throw x.call(this,a,c,b),c.Talk(),new G},function(){c.Talk()}):(d.exec({node:a.node},b),void c.Talk())},function(){c.Talk()})};var P=n.prototype=new i;P.parse=function(){return this.child=o.call(this.reason(),this),this},P.exec=function(a,b){var c=b.eventPicker({cache:b,action:"complete",empty:!0});return this.reverse()||this.operator()?void g.call(this,this.child,a.node,function(d){l.call(this,this.reverse(),d,function(d){c.Wait(),m.call(this,this.operator(),d,a.node,function(a){b.eventTrigger({action:"success",args:a})},function(){c.Talk()})})},function(){c.Talk()}):(x.call(this,a.node,c,b),void c.Talk())},P.reverse=function(){return this._reverse||0},P.operator=function(){return this._operator||0},P.next=function(a){return a?this._next===a:this._next};var Q="\\s*(?:(\\.)|(\\^)?(-?\\d*~\\d*|-\\d+)\\.?|(\\d+|[a-z_][a-z\\d\\-_]*)\\.?|(\\^)?([*#+])\\.?|\\$([a-z\\d_]+)\\.?|(:)|(\\[|\\()|.+)\\s*",R=new RegExp(Q,"g"),S=p.prototype=new i;S.parse=function(){return this.filter=h.call(this.reason(),this),this.child=o.call(this.reason(),this),this},S.exec=function(a,b){var c=a.node,d=b.eventPicker({cache:b,action:"complete",empty:!0}),e=this;g.call(this,this.filter,c,function(a){a&&x.call(e,c,d,b)},function(){d.Talk()})};var T=/^(-?\d+)?~(\d+)?$/,U=q.prototype=new i;U.parse=function(){return this.child=o.call(this.reason(),this),this},U.exec=function(a,c){function d(a){var d=this.specific();if(d)try{g.call(this,d,a,function(d){if(!d)throw new b;x.call(this,a,null,c)},function(){})}catch(e){if(e instanceof b)throw new F}else x.call(this,a,null,c)}var e,f=c.eventPicker({cache:c,action:"complete",empty:!0}),h={self:this,reverse:this._revlist};E.call(a.node.itemLimit,"Function")?(h.start=this._start,h.limit=this._limit,e=a.node.itemLimit):(h.start=this._start||0,h.limit=this._limit||10,e=a.node.xEach),e.callback.call(a.node,h,d),f.Talk()};var V=r.prototype=new i;V.parse=function(){return this.child=o.call(this.reason(),this),this},V.exec=function(a,b){x.call(this,a.node.__parent__,null,b)};var W=s.prototype=new i;W.parse=function(){return this.child=o.call(this.reason(),this),this},W.exec=function(a,b){var c=b.eventPicker({cache:b,action:"complete",empty:!0});E.call(a.node,"Object")&&-1!==Object.keys(a.node).indexOf(this.attr())||E.call(a.node,"Array")&&a.node[this.attr()]?x.call(this,a.node[this.attr()],c,b):this._valkey?a.node=this.child.exec({node:this.attr()},b):this.attr()||x.call(this,a.node,c,b),c.Talk()},W.attr=function(){return this._attr};var X=t.prototype=new i;X.parse=function(){return this.child=o.call(this.reason(),this),this},X.exec=function(a,b){K[this.type()].call(this,a.node,b)},X.type=function(){return this._type};var Y="(?:[^)\\\\]*|\\\\\\)|\\\\)+",Z="(?:(\\.)|(\\w+)(?:\\(("+Y+")\\))?\\.?)\\s*|.+",$=new RegExp(Z,"g"),_=/\\([\(\)])/g,aa=v.prototype=new i;aa.parse=function(){return this.child=u.call(this.reason(),this),this},aa.exec=function(b,c){function d(a){x.call(i,a,h,c)}function e(){h.Talk()}var g,h,i=this,j=b.node[this.name()];if(f(j)){if(h=c.eventPicker({cache:c,action:"complete",empty:!0}),!j.tick)return b.node=j.apply(b.node,this.args()),x.call(this,b.node,h,c),void h.Talk();g=a.callSchema(j.schema||j.tick,this.args()),j.call(b.node,g,d,e,h)}},aa.name=function(){return this._name||"toString"},aa.args=function(){return[].xAdd(this._args)};var ba=w.prototype=new i;ba.exec=function(a,b){var c=b.eventPicker({cache:b,action:"complete",empty:!0}),d=this._key?this._value[this._key]:this._value;x.call(this,d,c,b),c.Talk()},z.prototype={valueKey:function(a){var b=this._values[a];return E.call(b,"Function")?b.call(this):b},rootSelf:function(){for(var a=this._values.self;a.__parent__;)a=a.__parent__;return a}},a.ns("util.path").prototypes={pathNode:A,pathFind:B,pathExists:C},a.definePath=function(a){Object.defineProperties(a,{pathNode:{value:A},pathFind:{value:B},pathExists:{value:C}})}}(Crisp);